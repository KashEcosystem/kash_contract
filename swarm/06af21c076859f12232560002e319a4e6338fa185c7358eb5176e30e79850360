// SPDX-License-Identifier: MIT
pragma solidity 0.8.24;

// Sử dụng Named Import để tránh lỗi "global import"
import {ERC20} from "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import {ERC20Burnable} from "@openzeppelin/contracts/token/ERC20/extensions/ERC20Burnable.sol";
import {Ownable} from "@openzeppelin/contracts/access/Ownable.sol";

contract Kash is ERC20, ERC20Burnable, Ownable {
    error TradingClosed(); 
    error Blacklisted(); 
    error TxLimit(); 
    error WalletLimit(); 
    error LimitsGone();

    uint256 public constant MAX_SUPPLY = 52_000_000 * 10**18;
    uint256 public maxLimit = 104_000 * 10**18;
    bool public tradingOpen;
    bool public limitsActive = true;

    mapping(address => bool) public blacklisted;
    mapping(address => bool) public excluded;

    constructor() ERC20("Kash", "KASH") Ownable(msg.sender) {
        excluded[msg.sender] = true;
        excluded[address(this)] = true;
        _mint(msg.sender, MAX_SUPPLY);
    }

    function startTrading() external onlyOwner { tradingOpen = true; }
    function removeLimits() external onlyOwner { limitsActive = false; }
    function setBlacklist(address acc, bool state) external onlyOwner { blacklisted[acc] = state; }
    function setExcluded(address acc, bool state) external onlyOwner { excluded[acc] = state; }
    
    function setMaxLimit(uint256 amount) external onlyOwner {
        if(!limitsActive) revert LimitsGone();
        maxLimit = amount * 10**18;
    }

    // Ghi đè hàm _update (Tiêu chuẩn OpenZeppelin v5.0)
    function _update(address from, address to, uint256 val) internal override {
        // 1. Cho phép Mint, Burn và các địa chỉ ngoại lệ (Whitelisted)
        if (from == address(0) || to == address(0) || excluded[from] || excluded[to]) {
            super._update(from, to, val);
            return;
        }

        // 2. Kiểm tra trạng thái giao dịch
        if (!tradingOpen) revert TradingClosed();
        if (blacklisted[from] || blacklisted[to]) revert Blacklisted();

        // 3. Kiểm tra giới hạn ví và giới hạn giao dịch
        if (limitsActive) {
            if (val > maxLimit) revert TxLimit();
            if (balanceOf(to) + val > maxLimit) revert WalletLimit();
        }
        
        super._update(from, to, val);
    }
}